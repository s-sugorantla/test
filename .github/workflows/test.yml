name: Upload Prowler HTML Report

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Environment
        required: true
        options:
          - test
          - app
jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure AWS credentials
        run: |
          echo ${{ secrets.AWS_ACCESS_KEY_ID }} >> ~/.aws/credentials
          echo ${{ secrets.AWS_SECRET_ACCESS_KEY }} >> ~/.aws/credentials
          echo "[default]" >> ~/.aws/config
          echo "region=${{ secrets.AWS_DEFAULT_REGION }}" >> ~/.aws/config

      - name: Run Prowler and generate HTML report
        run: |
          git clone https://github.com/prowler-cloud/prowler
          cd prowler
          poetry shell
          poetry install
          python prowler.py aws --profile default -f us-east-1 -M html
      - name: Upload HTML report to S3 bucket
        run: |
          aws s3 cp prowler-report-${{ github.sha }}.html s3://test-sur/
